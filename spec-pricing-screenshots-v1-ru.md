# Спецификация v1: сервис скриншотов pricing-страниц с выгрузкой в PDF

## Assumptions
- Продукт в v1 ориентирован на B2B-пользователей: маркетолог, продакт, представитель агентства, фаундер.
- Продукт в v1 реализуется как web-only сервис (без extension) и разворачивается на хостинге владельца продукта.
- Входной формат в v1: только строка доменов через запятую (`a.com, b.com`).
- Максимум доменов за один запуск: 10.
- Базовый поиск pricing-страницы в v1: сначала `https://<domain>/pricing`, затем `http://<domain>/pricing` как fallback.
- Итоговый артефакт: один PDF-файл, где 1 домен = 1 страница.
- Если pricing-страница не найдена, в PDF по домену фиксируется заметка с причиной.
- Скриншоты и PDF не хранятся персистентно на сервере.
- История запусков хранится и отправляется в аналитику в формате логов с указанием `user_id`.
- Retention аналитических логов с `user_id`: 90 дней.

## Open Questions
- Нет открытых вопросов для v1.

## 1. Product Spec

### 1.1 Summary
- Цель: дать пользователю быстрый способ получить единый PDF с визуальной фиксацией pricing-страниц конкурентов.
- Ценность: убрать ручной обход сайтов и ручную сборку отчета.
- Основные бизнес-метрики:
  - `Screenshot Success Rate` (SSR): доля доменов с успешно снятыми обязательными скриншотами.
  - `PDF Completion Rate` (PCR): доля запусков, завершившихся валидным PDF.
  - `Domain Coverage Rate` (DCR): доля введенных валидных доменов, по которым выполнена попытка обработки (включая ошибки) — ожидаемо 100%.

### 1.2 Problem and Users
- Пользователи:
  - Маркетолог.
  - Продакт-менеджер.
  - Представитель маркетингового агентства.
  - Фаундер.
- Основные use cases:
  - Собрать доказательную визуальную выборку pricing-страниц конкурентов перед анализом.
  - Сравнить pricing-экраны нескольких доменов в одном документе.
  - Получить артефакт для внутренней коммуникации (PDF).
- Non-goals v1:
  - Автоматический анализ цен/тарифов из текста страницы.
  - Поиск pricing в нескольких путях кроме `/pricing`.
  - Обход капчи/антибот-систем.

### 1.3 Scope
- In scope:
  - Ввод доменов через запятую.
  - Дедупликация доменов во входе (по первому вхождению, с сохранением порядка).
  - Проверка до 10 доменов за запуск.
  - Поиск `/<pricing>` с fallback `https -> http`.
  - Скриншоты: desktop viewport, mobile viewport, desktop full-page, mobile full-page.
  - Генерация одного PDF с 1 страницей на домен.
  - Фиксация причины неуспеха в PDF.
  - Мгновенное скачивание PDF на устройство пользователя без серверного хранения файла.
  - Сбор истории запусков в виде аналитических логов с `user_id`, списком доменов и статусами генерации.
- Out of scope:
  - CSV/файл-аплоад.
  - Любые пути кроме `/pricing`.
  - OCR/структурирование цен из скринов.
  - API для внешних интеграций.
  - Browser extension интерфейс в v1.

### 1.4 Inputs and Outputs
- Input:
  - Единственное текстовое поле: строка доменов через запятую.
  - Пример: `stripe.com, notion.so, example.com`.
- Validation rules:
  - Удаление пробелов по краям.
  - Фильтрация пустых токенов.
  - Дедупликация одинаковых доменов с сохранением первого вхождения.
  - Лимит: максимум 10 валидных доменов.
  - Если после дедупликации валидных доменов меньше 10 (включая 1), обрабатываются все.
- Output:
  - Единый PDF-файл на запуск.
  - В PDF для каждого домена:
    - Заголовок = домен.
    - `date stamp` в локальном времени пользователя.
    - URL фактически открытой страницы (`https://<domain>/pricing` или `http://<domain>/pricing`).
    - Скриншоты (viewport + full-page, desktop и mobile) или заметка об ошибке.

### 1.5 Functional Requirements
| ID | Requirement | Priority | Rationale | Acceptance metric |
| --- | --- | --- | --- | --- |
| FR-1 | Система принимает строку доменов через запятую, валидирует и дедуплицирует домены до лимита 10 уникальных доменов. | P0 | Базовый входной интерфейс и защита от дублирующих обходов. | 100% запусков с валидным input проходят pre-check без падений; ввод >10 уникальных доменов блокируется с понятной ошибкой; дедупликация детерминирована. |
| FR-2 | Для каждого валидного домена выполняется переход на `https://<domain>/pricing`, при неуспехе выполняется fallback на `http://<domain>/pricing`. | P0 | Повышает процент успешной обработки без усложнения логики поиска путей. | `DCR = 100%` для всех валидных доменов; fallback вызывается в 100% кейсов неуспешного `https`. |
| FR-3 | При успешной загрузке pricing-страницы система снимает desktop viewport screenshot. | P0 | Основная визуальная фиксация. | SSR desktop viewport >= 95% на доступных без капчи страницах. |
| FR-4 | При успешной загрузке pricing-страницы система снимает mobile viewport screenshot. | P0 | Проверка мобильного отображения. | SSR mobile viewport >= 95% на доступных без капчи страницах. |
| FR-5 | Система снимает desktop full-page screenshot. | P1 | Нужен полный контекст страницы. | Успешность desktop full-page >= 92% на доступных страницах. |
| FR-6 | Система снимает mobile full-page screenshot. | P1 | Нужен полный мобильный контекст. | Успешность mobile full-page >= 92% на доступных страницах. |
| FR-7 | Если pricing не найден/недоступен, в PDF по домену выводится заметка с причиной. | P0 | Прозрачность результата. | 100% неуспешных доменов имеют код причины в PDF. |
| FR-8 | Генерируется единый PDF: 1 домен = 1 страница, порядок как во входе. | P0 | Предсказуемость и удобство сравнения. | `PCR >= 98%`; совпадение порядка доменов 100%. |
| FR-9 | На каждой странице PDF присутствуют: домен (title), локальный timestamp пользователя, URL фактически открытой страницы. | P0 | Трассируемость измерения. | 100% страниц содержат все три обязательных поля. |
| FR-10 | Сервис обрабатывает все уникальные валидные домены после дедупликации, даже если их <10. | P0 | Явное требование пользователя. | Для `Nuniq in [1..10]` обработано ровно `Nuniq` доменов (attempted). |
| FR-11 | Сервис предоставляется как web-only приложение и корректно работает при self-hosted развертывании на инфраструктуре владельца продукта. | P0 | Явное требование по каналу доступа и модели размещения. | 100% обязательных функций доступны через web UI; smoke-тест деплоя проходит в целевом окружении. |
| FR-12 | Пользователь получает понятный статус запуска (успех/частичный успех/ошибка). | P1 | Прозрачность обработки. | 100% запусков завершаются конечным статусом и кратким summary. |
| FR-13 | Скриншоты и PDF не сохраняются персистентно на сервере; PDF отдается пользователю сразу после генерации. | P0 | Явное требование по приватности и хранению. | 100% запусков соответствуют политике `no server persistence`; серверный retention = 0 для артефактов. |
| FR-14 | История запусков отправляется в аналитику в формате событийных логов с `user_id` и метаданными запуска (без файлов): число доменов, список доменов, статус создания PDF (success/fail), статусы по доменам. | P0 | Нужна наблюдаемость продукта и аналитика использования. | >=99% успешных отправок логов; 100% событий содержат `user_id`, `domains_count`, `domains[]`, `pdf_status`; 0 файловых артефактов в аналитике; retention логов = 90 дней. |

### 1.6 Non-Functional Requirements
- Производительность:
  - SLA времени генерации PDF: p95 <= 120 секунд для запуска с 10 доменами.
- Надежность:
  - Целевая доступность сервиса: 99.5% в месяц.
- Ограничения по нагрузке:
  - До 10 доменов на один запуск.
  - Ограничение параллелизма внутри одного запуска, чтобы снизить риск блокировок.
- Антибот/этика сбора:
  - Без обхода капчи, без антидетект-механик.
  - Аккуратные таймауты и паузы между доменами (политика polite crawling).
- Безопасность:
  - Валидация пользовательского input, защита от SSRF через allowlist схемы и нормализацию доменов.
- Развертывание:
  - Поддержка self-hosted конфигурации (env-переменные, секреты, домен, TLS) без SaaS-зависимости для основного контура.
- Хранение данных:
  - Сервер не хранит персистентно скриншоты и итоговый PDF.
  - Артефакты могут существовать только в оперативной памяти/временном процессе до выдачи пользователю.
  - Допускается хранение только аналитических логов истории запусков (метаданные + `user_id`, без скриншотов/PDF).
  - Retention аналитических логов: 90 дней с автоматическим удалением по TTL.

### 1.7 Data and Knowledge
- Источник данных:
  - Публично доступные pricing-страницы доменов пользователя.
- Свежесть:
  - Данные снимаются on-demand на момент запуска.
- Чувствительные данные:
  - Пользовательские домены считаются рабочими данными.
  - Скриншоты и PDF выдаются пользователю и не сохраняются персистентно на сервере.
  - В аналитике сохраняются метаданные запуска: `run_id`, `user_id`, количество доменов до/после дедупликации, `domains[]`, `pdf_status`, статусы по доменам, длительность, коды ошибок.

### 1.8 Architecture (v1)
- Клиенты:
  - Web UI.
- Backend:
  - API запуска задачи.
  - Worker со headless browser (эмуляция desktop/mobile).
  - Сервис генерации PDF со streaming-выдачей результата клиенту.
  - Только in-memory буфер во время выполнения задачи (без персистентного storage).
  - Сервис событийной аналитики (ingest логов запусков с `user_id` и доменными метаданными).
- Режимы съемки:
  - Desktop viewport: `1366x768`.
  - Mobile viewport: `390x844`.
  - Desktop full-page.
  - Mobile full-page.

### 1.9 UX and Safety
- UX:
  - Простая форма ввода доменов и одна кнопка запуска.
  - Понятный индикатор прогресса по доменам.
- Safety:
  - Явные причины ошибок по домену: `NOT_FOUND`, `TIMEOUT`, `BLOCKED`, `DNS_ERROR`, `UNKNOWN`.
  - Никаких попыток обхода защит сайта.

### 1.10 Risks and Mitigations
| Risk | Impact | Likelihood | Mitigation |
| --- | --- | --- | --- |
| `/pricing` отсутствует у части сайтов | Medium | High | Явная заметка в PDF, расширение поиска путей в v2. |
| Блокировки/капча | Medium | Medium | Polite crawling, ограничение параллелизма, таймауты. |
| Перегруженная страница PDF из-за full-page скринов | Medium | Medium | Масштабирование изображений + фиксированный шаблон верстки страницы. |
| Некорректные домены на входе | Medium | High | Строгая валидация и user-friendly ошибки до запуска. |
| Ошибки/потери аналитических логов | Medium | Medium | Ретраи отправки событий, DLQ, мониторинг Log Delivery Rate. |
| Риск приватности связки `user_id + domains[]` | Medium | Medium | Политика доступа к аналитике, минимизация полей, шифрование in-transit/at-rest и ретеншн-политика. |

### 1.11 Success Metrics and Guardrails
- Основные KPI:
  - SSR >= 95% (для доступных без капчи pricing-страниц).
  - PCR >= 98%.
  - DCR = 100%.
  - p95 времени генерации PDF для N=10 <= 120 секунд.
  - Log Delivery Rate (LDR) >= 99%.
- Guardrails:
  - Если SSR падает ниже 90% за сутки, включается алерт и релиз фич блокируется.
  - Если PCR ниже 95% за сутки, запускается incident-review.
  - Если p95 runtime для N=10 превышает 120 секунд в течение суток, новый rollout останавливается.
  - Если LDR < 98% за сутки, включается алерт на аналитический пайплайн.

### 1.12 Dependencies and Milestones
- Dependencies:
  - Headless browser runtime.
  - PDF generator.
  - Логи и мониторинг.
- Milestones:
  - M1: Web MVP с ручным запуском и PDF.
  - M2: Self-hosted deployment pack + auth и `user_id`-based аналитика.
  - M3: Наблюдаемость, quality gates, подготовка к rollout.

### 1.13 Dependencies on Evaluation and Delivery
- До production запуска FR-1..FR-14 должны пройти формальные quality bars из evaluation плана.
- Релиз возможен только при наличии мониторинга SSR/PCR/DCR и rollback-плана.

## 2. Evaluation Plan

### 2.1 Evaluation Objectives
- Подтвердить, что сервис стабильно обрабатывает 1..10 доменов и выдает корректный PDF-артефакт.
- Проверить целевые уровни SSR, PCR, DCR.

### 2.2 Test Sets
- Набор доменов (минимум 120):
  - 40 доменов с валидным `/pricing`.
  - 40 доменов без `/pricing`.
  - 20 доменов, где `https` недоступен, но `http` доступен.
  - 20 доменов с редиректами/медленной загрузкой/ошибками.
- Наборы входов по размеру: N=1, 3, 5, 10.

### 2.3 Metrics
- Automatic:
  - SSR (desktop viewport, mobile viewport, desktop full-page, mobile full-page).
  - PCR.
  - DCR.
  - Среднее и p95 время генерации PDF.
  - `No-persistence compliance` (доля запусков без серверного хранения артефактов).
  - `Dedup correctness` (корректность удаления дублей без потери уникальных доменов).
  - `Log Delivery Rate` и полнота аналитических событий по `run_id/user_id`.
- Human checks (sample 10%):
  - Читаемость скриншотов в PDF.
  - Корректность домена, timestamp и URL на каждой странице.

### 2.4 Baselines and Comparisons
- Baseline:
  - Ручной процесс пользователя (вручную открыть `/pricing`, сделать скрины, собрать PDF).
- Ожидаемое улучшение:
  - Существенное сокращение ручного времени (целевое значение TBD после пилота).

### 2.5 Coverage Matrix
| Requirement ID | Test cases | Metric | Pass threshold |
| --- | --- | --- | --- |
| FR-1 | 60 разных input-строк с дублями/без дублей | Validation + dedup correctness | 100% корректная валидация и детерминированная дедупликация |
| FR-2 | 120 доменов, включая https-fail/http-pass | DCR + fallback correctness | DCR=100%, fallback path=100% в релевантных кейсах |
| FR-3 | 40 доступных pricing | SSR desktop viewport | >=95% |
| FR-4 | 40 доступных pricing | SSR mobile viewport | >=95% |
| FR-5 | 40 доступных pricing | SSR desktop full-page | >=92% |
| FR-6 | 40 доступных pricing | SSR mobile full-page | >=92% |
| FR-7 | 40 недоступных pricing | Error note coverage | 100% |
| FR-8 | 80 запусков | PCR + order correctness | PCR>=98%, порядок=100% |
| FR-9 | 300 страниц PDF | Metadata completeness | 100% |
| FR-10 | 40 запусков N=1..10 c дублями во входе | Attempted unique domains | 100% |
| FR-11 | 20 self-hosted деплоев в целевых окружениях | Deployment smoke success | 100% |
| FR-12 | 80 запусков | Final status presence | 100% |
| FR-13 | 80 запусков | No-persistence compliance | 100% |
| FR-14 | 80 запусков | Log Delivery Rate + payload schema/policy | LDR>=99%, 100% payload с `user_id/domains_count/domains[]/pdf_status`, 0 файловых артефактов |

### 2.6 Protocol
- Offline/QA:
  - Ежедневный прогон smoke-набора.
  - Перед релизом: полный regression на 120 доменах.
- Pilot online:
  - Ограниченная группа пользователей (10-20).
  - Сбор обратной связи по читаемости PDF и полезности результата.

### 2.7 Quality Bars (Go/No-Go)
- Must-pass:
  - SSR viewport >=95%.
  - SSR full-page >=92%.
  - PCR >=98%.
  - DCR =100%.
  - p95 времени генерации для N=10 <= 120 секунд.
  - 100% страниц PDF содержат домен, timestamp, URL.
  - 100% запусков соответствуют политике отсутствия серверного хранения скриншотов/PDF.
  - Log Delivery Rate >=99%, отсутствие скриншотов/PDF в аналитике, и 100% обязательных полей (`user_id`, `domains[]`, `pdf_status`) в событиях.
  - Политика retention для аналитических логов (`90 дней`) соблюдается на 100% событий.
- Nice-to-have:
  - p95 времени генерации для N<=5 <= 60 секунд.

### 2.8 Error Analysis
- Трекаемые классы ошибок:
  - `NOT_FOUND`, `TIMEOUT`, `BLOCKED`, `DNS_ERROR`, `RENDER_ERROR`.
- Еженедельный разбор top-ошибок и долей по классам.

### 2.9 Safety and Risk Evaluation
- Проверка, что сервис не пытается обходить капчу.
- Проверка корректной нормализации доменов и защиты от небезопасных URL.

### 2.10 Reporting
- Дашборд релиз-готовности:
  - SSR, PCR, DCR, p95 runtime, LDR, распределение ошибок, распределение `pdf_status`.
- Частота:
  - Ежедневно в пилоте, затем еженедельно.

## 3. Delivery Plan

### 3.1 Release Scope
- v1 includes:
  - Ввод доменов строкой через запятую.
  - Дедупликация одинаковых доменов во входе.
  - Обход `/pricing` с fallback `https -> http`.
  - 4 типа скриншотов.
  - PDF: 1 домен = 1 страница.
  - Заметки об ошибках.
  - Локальный timestamp пользователя в PDF.
  - Скачивание PDF сразу на устройство пользователя без серверного хранения файла.
  - История запусков как аналитические логи с `user_id`, `domains[]`, `domains_count`, `pdf_status`.
- Deferred:
  - Альтернативные пути (`/plans`, `/subscriptions`).
  - Распознавание цен и авто-сравнение тарифов.

### 3.2 Deployment Plan
- Environments:
  - Dev -> Staging -> Prod.
- Rollout sequence:
  - Web MVP в self-hosted окружении.
  - Расширение окружений/нагрузки в рамках той же web-архитектуры.
- Data handling:
  - Генерация скриншотов и PDF в рамках job с in-memory артефактами.
  - После выдачи PDF пользователю артефакты уничтожаются.
  - Отдельно отправляются события аналитики по запуску (`run_id`, `user_id`, `domains[]`, `domains_count`, `pdf_status`, технические метаданные).

### 3.3 Rollout Strategy
- Stage 1:
  - Внутренний dogfood.
- Stage 2:
  - Пилот с ограниченной группой.
- Stage 3:
  - Широкий доступ после прохождения quality bars.
- Rollback criteria:
  - PCR <95% или DCR <100% в течение 24 часов.

### 3.4 Monitoring and Alerts
- Product:
  - Количество запусков, распределение N доменов, доля дедуплицированных запусков.
  - Успешные/неуспешные генерации PDF (`pdf_status`).
  - Топ доменов по запускам и срезы по `user_id`.
- Quality:
  - SSR/PCR/DCR.
- Runtime:
  - p95 времени генерации (целевой порог 120 секунд для N=10).
- Error:
  - Доли по кодам ошибок.
- Compliance:
  - Метрика no-persistence (ожидаемо 100%).
  - Метрика LDR и корректность состава аналитических payload.
  - Метрика соблюдения retention (90 дней).

### 3.5 Guardrails
- Ограничение до 10 доменов.
- Дедупликация доменов до старта обхода.
- Ограничение параллелизма и разумные таймауты.
- Явные ошибки пользователю без скрытых ретраев сверх лимита.
- Запрет на персистентное хранение скриншотов/PDF на сервере.
- Запрет на отправку файловых артефактов в аналитику; только метаданные запуска.

### 3.6 Ops and Ownership
- Owner продукта: Product.
- Owner надежности и пайплайна: Engineering.
- Инциденты:
  - P1: невозможность генерации PDF.
  - P2: деградация SSR.

### 3.7 Documentation and Enablement
- User docs:
  - Формат ввода доменов.
  - Правило дедупликации доменов.
  - Интерпретация статусов и причин ошибок.
- Internal docs:
  - Runbook по ошибкам рендеринга и блокировок.
  - Схема аналитических событий и поля с `user_id`, `domains[]`, `pdf_status`.

### 3.8 Feedback Loop
- Сбор feedback:
  - Оценка полезности PDF после генерации.
- Cadence:
  - Еженедельный разбор и приоритизация улучшений v1.1/v2.

## 4. Final Assumptions and Open Questions

### Assumptions
- Пользователю достаточно текущей стратегии поиска только `/pricing` в v1.
- Один PDF с 1 страницей на домен достаточен для рабочих сценариев.
- Скриншоты desktop/mobile viewport + full-page помещаются в читаемый шаблон страницы PDF.

### Open Questions
- Нет открытых вопросов для v1.

## 5. Competitive Landscape

### 5.1 Klue
**URL:** https://klue.com/

**Описание:**  
Платформа конкурентной разведки и Win-Loss анализа для B2B-компаний. Объединяет сбор competitive intelligence и программы анализа побед/поражений в одном месте.

**Ключевые возможности:**
- **Compete Agent** — AI-агент для автоматической доставки competitive insights продавцам прямо в CRM/Slack
- **Win-Loss анализ** — глубинные интервью с покупателями для выявления причин побед и поражений
- **Battlecards** — автоматически обновляемые карточки для продаж
- **Deal-based insights** — персонализированные рекомендации для каждой сделки
- **Интеграции** — Salesforce, HubSpot, Slack, Microsoft Teams

**Метрики (по данным кейсов):**
- 250,000+ пользователей
- +28% win-rate против топ-конкурентов (кейс Blackbaud)
- 10+ часов экономии в неделю на CI-задачи
- 72% adoption среди продавцов

**Pricing:**  
Не публикуется. Enterprise-модель с demo по запросу.

**Позиционирование:**  
G2 лидер в 4 категориях. Фокус на крупные B2B sales teams.

---

### 5.2 Kompyte (Semrush)
**URL:** https://www.kompyte.com/

**Описание:**  
Платформа автоматизированной конкурентной разведки от Semrush. Отслеживает действия конкурентов в реальном времени и доставляет actionable insights.

**Ключевые возможности:**
- **Real-time мониторинг** — автоматическое отслеживание сайтов, контента, соцсетей, рекламы, вакансий конкурентов
- **AI-powered insights** — ML-фильтрация шума, автоматические ежедневные саммари
- **Battlecards** — ready-to-use шаблоны для sales enablement
- **Website change detection** — уведомления об изменениях на сайтах конкурентов
- **SEO/PPC tracking** — анализ ключевых слов и рекламных кампаний конкурентов
- **Интеграции** — Salesforce, HubSpot, Slack, Microsoft Teams

**Tracking capabilities:**
- Изменения на сайтах
- Контент-мониторинг
- Social media
- Изменения цен
- Product updates
- Email-кампании
- Share of voice
- Sentiment analysis

**Pricing:**  
Subscription-based, custom pricing. Планы: Essentials, Professional, Unlimited. Зависит от количества лицензий и объёма сканирований. Enterprise-уровень. Пользователи Semrush могут получить скидку. Бесплатной версии нет, доступен trial.

**Позиционирование:**  
Часть экосистемы Semrush. Автоматизация CI для маркетинговых и sales команд.

---

### 5.3 Наше отличие
| Аспект | Klue/Kompyte | Наш сервис |
|--------|--------------|------------|
| Фокус | Полноценный CI + Win-Loss + Battlecards | Быстрый визуальный срез pricing-страниц |
| Сложность | Тяжёлые enterprise-платформы | Lightweight self-hosted сервис |
| Pricing | Enterprise (demo по запросу) | Self-hosted, бесплатно |
| Интеграции | CRM, Slack, BI | Standalone PDF export |
| Use case | Ongoing CI program | Разовый competitive snapshot |
| Time-to-value | Недели на onboarding | Минуты |
